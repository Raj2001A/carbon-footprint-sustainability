<app-navigation></app-navigation>

<main class="page">
  <section class="page-header">
    <h1>Dashboard</h1>
    <p class="muted">Overview of your tracked carbon emissions</p>
  </section>

  <section *ngIf="(total$ | async) as total; else loadingSkeleton" class="kpi-grid">
    <article class="kpi-card">
      <h2>Total Emissions</h2>
      <p class="kpi-value">{{ total | number:'1.0-2' }} kg CO<sub>2</sub></p>
      <p class="kpi-label">All time</p>
    </article>

    <article class="kpi-card" *ngIf="(monthlyAverage$ | async) as monthly">
      <h2>Monthly Average</h2>
      <p class="kpi-value">{{ monthly | number:'1.0-2' }} kg CO<sub>2</sub></p>
      <p class="kpi-label">Average per active month</p>
    </article>

    <article class="kpi-card" *ngIf="(highestSource$ | async) as highest; else noHighest">
      <h2>Highest Source</h2>
      <p class="kpi-value">{{ highest.co2Kg | number:'1.0-2' }} kg</p>
      <p class="kpi-label">{{ highest.category }}  {{ highest.activity }}</p>
    </article>
    <ng-template #noHighest>
      <article class="kpi-card">
        <h2>Highest Source</h2>
        <p class="kpi-value">-</p>
        <p class="kpi-label">Add an emission to see details</p>
      </article>
    </ng-template>

    <article class="kpi-card trend-card" *ngIf="(trend$ | async) as trend">
      <h2>Trend</h2>
      <p class="kpi-value" [ngClass]="trend">
        <span *ngIf="trend === 'up'"> Increasing</span>
        <span *ngIf="trend === 'down'"> Decreasing</span>
        <span *ngIf="trend === 'flat'"> Flat</span>
        <span *ngIf="trend === 'none'">No data</span>
      </p>
      <p class="kpi-label">Based on last two entries</p>
    </article>
  </section>

  <ng-template #loadingSkeleton>
    <section class="kpi-grid">
      <article class="kpi-card skeleton"></article>
      <article class="kpi-card skeleton"></article>
      <article class="kpi-card skeleton"></article>
      <article class="kpi-card skeleton"></article>
    </section>
  </ng-template>

  <!-- Monthly Chart Section -->
  <section class="chart-section">
    <div class="chart-container">
      <h2>Monthly Emissions Trend</h2>
      <canvas #monthlyChartCanvas></canvas>
    </div>
  </section>

  <!-- Top 5 Emissions Section -->
  <section class="top-emissions-section" *ngIf="(topEmissions$ | async) as topEmissions">
    <h2>Top 5 Emissions</h2>
    <div class="emissions-list">
      <div *ngFor="let emission of topEmissions; let i = index" class="emission-item">
        <div class="emission-rank">{{ i + 1 }}</div>
        <div class="emission-details">
          <div class="emission-header">
            <span class="emission-category" [ngClass]="emission.category.toLowerCase()">
              {{ emission.category }}
            </span>
            <span class="emission-value">{{ emission.co2Kg | number:'1.0-2' }} kg COâ‚‚</span>
          </div>
          <p class="emission-activity">{{ emission.activity }}</p>
          <p class="emission-date">{{ emission.date | date:'MMM d, yyyy' }}</p>
        </div>
        <div class="emission-bar">
          <div class="bar-fill" [style.width.%]="(emission.co2Kg / (topEmissions[0].co2Kg || 1)) * 100"></div>
        </div>
      </div>
    </div>
  </section>

  <section class="hint">
    <p>
      Start by <a routerLink="/add">adding an emission entry</a>. The dashboard, table, and chart
      will update automatically.
    </p>
  </section>
</main>
